name: AppSec Approval Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  check-appsec-approval:
    name: Check AppSec Team Approval
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to get all history for changed files check

      - name: Check for changes in sensitive directories
        id: check-changes
        run: |
          # Get the base branch (usually main/master)
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Check for changes in specified directories
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          SENSITIVE_CHANGES=false
          
          # List of sensitive directories to check
          SENSITIVE_DIRS=(
            ".github/"
            "batch/"
            "ci/"
            "auth/"
            "gear/"
            "gateway/"
            "grafana/"
            "guide/"
            "infra/"
            "internal-gateway/"
            "letsencrypt/"
            "monitoring/"
            "prometheus/"
            "tls/"
            "ukbb-rg/"
            "web_common/"
            "website/"
          )
          
          for FILE in $CHANGED_FILES; do
            for DIR in "${SENSITIVE_DIRS[@]}"; do
              if [[ $FILE == $DIR* ]]; then
                SENSITIVE_CHANGES=true
                echo "Found changes in sensitive directory: $DIR"
                break 2
              fi
            done
          done
          
          echo "sensitive-changes=$SENSITIVE_CHANGES" >> $GITHUB_OUTPUT

      - name: Check AppSec team approval
        if: steps.check-changes.outputs.sensitive-changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        id: check-approval
        run: |
          # Get the PR reviews
          REVIEWS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews)
          
          # Check if any member of the appsec team has approved
          APPROVED=false
          
          # Get the list of members in the appsec team
          TEAM_MEMBERS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /orgs/hail-is/teams/appsec/members | jq -r '.[].login')
          
          # Check if any team member has approved
          echo "$REVIEWS" | jq -r '.[] | select(.state=="APPROVED") | .user.login' | while read REVIEWER; do
            if echo "$TEAM_MEMBERS" | grep -q "^${REVIEWER}$"; then
              APPROVED=true
              echo "Found approval from AppSec team member: $REVIEWER"
              break
            fi
          done
          
          if [ "$APPROVED" = "true" ]; then
            echo "AppSec team approval found"
            exit 0
          else
            echo "No AppSec team approval found yet"
            exit 1
          fi

      - name: Set status
        if: steps.check-changes.outputs.sensitive-changes == 'true' && failure()
        run: |
          echo "Changes in sensitive directories require approval from the AppSec team"
          exit 1 
